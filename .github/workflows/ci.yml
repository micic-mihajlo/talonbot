name: ci

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  unit:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: npm
      - name: Install dependencies
        run: npm ci
      - name: Unit tests
        run: npm run test:unit

  integration:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: npm
      - name: Install dependencies
        run: npm ci
      - name: Build
        run: npm run build
      - name: Integration tests
        run: npm run test:integration

  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: npm
      - name: Install dependencies
        run: npm ci
      - name: Build
        run: npm run build
      - name: Release tests
        run: npm run test:release

  shell:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: npm
      - name: Install dependencies
        run: npm ci
      - name: Shell ops tests
        run: npm run test:shell

  doctor-security:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: npm
      - name: Install dependencies
        run: npm ci
      - name: Build
        run: npm run build
      - name: Doctor preflight
        run: >
          ENGINE_MODE=mock
          CONTROL_AUTH_TOKEN=ci-control-token-very-long-without-shortcuts
          DISCORD_ENABLED=true
          DISCORD_TOKEN=ci-discord-token-placeholder
          CONTROL_HTTP_PORT=8080
          npm run doctor -- --strict

      - name: Security audit smoke
        run: |
          DATA_DIR=/tmp/talonbot-data \
          CONFIG_FILE=/tmp/talonbot-config.env \
          RELEASE_ROOT_DIR=/tmp/talonbot-release \
          STARTUP_INTEGRITY_MODE=warn \
          bash -lc 'mkdir -p /tmp/talonbot-data/security /tmp/talonbot-release && echo CONTROL_AUTH_TOKEN=ci-control-token-very-long-without-shortcuts > /tmp/talonbot-config.env && ./bin/security-audit.sh'

  smoke:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: npm
      - name: Install dependencies
        run: npm ci
      - name: Build
        run: npm run build
      - name: Runtime smoke
        run: npm run test:smoke
