name: ci

on:
  push:
    branches:
      - main
  pull_request:

concurrency:
  group: ci-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: npm
      - name: Install dependencies
        run: npm ci
      - name: Build
        run: npm run build

  lint:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: npm
      - name: Install dependencies
        run: npm ci
      - name: Lint
        run: npm run lint

  typecheck:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: npm
      - name: Install dependencies
        run: npm ci
      - name: Typecheck
        run: npm run typecheck

  tests:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: npm
      - name: Install dependencies
        run: npm ci
      - name: Test suite
        run: npm test

  smoke:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: npm
      - name: Install dependencies
        run: npm ci
      - name: Build
        run: npm run build
      - name: Runtime smoke
        run: npm run test:smoke

  p0-gates:
    if: ${{ always() }}
    needs: [build, lint, typecheck, tests, smoke]
    runs-on: ubuntu-latest
    steps:
      - name: Validate required P0 gates
        run: |
          set -euo pipefail
          gates=(
            "build:${{ needs.build.result }}"
            "lint:${{ needs.lint.result }}"
            "typecheck:${{ needs.typecheck.result }}"
            "tests:${{ needs.tests.result }}"
            "smoke:${{ needs.smoke.result }}"
          )

          for gate in "${gates[@]}"; do
            IFS=':' read -r name result <<<"$gate"
            echo "$name => $result"
            if [ "$result" != "success" ]; then
              echo "P0 gate failed: $name"
              exit 1
            fi
          done

  doctor-security:
    runs-on: ubuntu-latest
    needs: p0-gates
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: npm
      - name: Install dependencies
        run: npm ci
      - name: Build
        run: npm run build
      - name: Doctor preflight
        run: >
          ENGINE_MODE=mock
          CONTROL_AUTH_TOKEN=ci-control-token-very-long-without-shortcuts
          DISCORD_ENABLED=true
          DISCORD_TOKEN=ci-discord-token-placeholder
          CONTROL_HTTP_PORT=8080
          npm run doctor -- --strict

      - name: Security audit smoke
        run: |
          DATA_DIR=/tmp/talonbot-data \
          CONFIG_FILE=/tmp/talonbot-config.env \
          RELEASE_ROOT_DIR=/tmp/talonbot-release \
          STARTUP_INTEGRITY_MODE=warn \
          bash -lc 'mkdir -p /tmp/talonbot-data/security /tmp/talonbot-release && echo CONTROL_AUTH_TOKEN=ci-control-token-very-long-without-shortcuts > /tmp/talonbot-config.env && ./bin/security-audit.sh'
